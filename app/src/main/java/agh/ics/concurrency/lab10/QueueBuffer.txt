package org.example.buffer;
import org.jcsp.lang.*;

import java.util.Deque;
import java.util.ArrayDeque;

import org.example.utilities.*;

public class QueueBuffer implements CSProcess {
    final private Stats stats;
    final private One2OneChannelInt[] fromProducerChannels;
    final private One2OneChannelInt[] toProducerChannels;
    final private One2OneChannelInt[] fromConsumerChannels;
    final private One2OneChannelInt[] toConsumerChannels;
    final private One2OneChannel<PassPayload> passProducerChannel;
    final private One2OneChannel<PassPayload> receivePassedProducerChannel;
    final private One2OneChannel<PassPayload> passConsumerChannel;
    final private One2OneChannel<PassPayload> receivePassedConsumerChannel;
    final private int bufferSize;
    final private int Id;
    private int current; 

    public QueueBuffer (One2OneChannelInt[] fromProducerChannels, One2OneChannelInt[] toProducerChannels,
                          One2OneChannelInt[] fromConsumerChannels, One2OneChannelInt[] toConsumerChannels, 
                          One2OneChannel<PassPayload> passProducerChannel, One2OneChannel<PassPayload> receivePassedProducerChannel,
                          One2OneChannel<PassPayload> passConsumerChannel, One2OneChannel<PassPayload> receivePassedConsumerChannel, 
                          int bufferSize, Stats stats, int Id) {
        this.stats = stats;
        this.fromProducerChannels = fromProducerChannels;
        this.toProducerChannels = toProducerChannels;
        this.fromConsumerChannels = fromConsumerChannels;
        this.toConsumerChannels = toConsumerChannels;
        this.passProducerChannel = passProducerChannel;
        this.receivePassedProducerChannel = receivePassedProducerChannel;
        this.passConsumerChannel = passConsumerChannel;
        this.receivePassedConsumerChannel = receivePassedConsumerChannel;
        this.bufferSize = bufferSize;
        this.Id = Id;
        this.current = bufferSize / 2;
    }

    public void run () {
        Guard[] guards = new Guard[fromProducerChannels.length + fromConsumerChannels.length + 2];
        for (int i = 0; i < fromProducerChannels.length; i++) {
            guards[i] = fromProducerChannels[i].in();
        }
        for (int i = 0; i < fromConsumerChannels.length; i++) {
            guards[fromProducerChannels.length + i] = fromConsumerChannels[i].in();
        }
        guards[guards.length - 2] = receivePassedProducerChannel.in();
        guards[guards.length - 1] = receivePassedConsumerChannel.in();

        Alternative alt = new Alternative(guards);

        Deque<Integer> producerQueue = new ArrayDeque<>();
        Deque<Integer> consumerQueue = new ArrayDeque<>();

        while (true) {
            int index = alt.select();
            if (index < fromProducerChannels.length) {
                int producerIndex = index;
                if (fromProducerChannels[producerIndex].in().read() == Payload.WHERE.ordinal()) {
                    if (current < bufferSize) {
                        toProducerChannels[producerIndex].out().write(Payload.HERE.ordinal()); 
                        if (fromProducerChannels[producerIndex].in().read() == Payload.PACKAGE.ordinal()) {
                            current++;
                            stats.recordProduced(producerIndex);
                            if (!consumerQueue.isEmpty()) {
                                int queuedConsumerIndex = consumerQueue.removeFirst();
                                toConsumerChannels[queuedConsumerIndex].out().write(Payload.HERE.ordinal());
                                toConsumerChannels[queuedConsumerIndex].out().write(Payload.PACKAGE.ordinal());
                                current--;
                                stats.recordConsumed(queuedConsumerIndex);
                            }
                        }                      
                    } else {
                        passProducerChannel.out().write(new PassPayload(Id, producerIndex));
                        stats.recordProducerPass(producerIndex); 
                    }
                }

            } else if (index < fromProducerChannels.length + fromConsumerChannels.length) {
                int consumerIndex = index - fromProducerChannels.length;
                if (fromConsumerChannels[consumerIndex].in().read() == Payload.WHERE.ordinal()) {
                    if (current > 0) {
                        toConsumerChannels[consumerIndex].out().write(Payload.HERE.ordinal()); 
                        toConsumerChannels[consumerIndex].out().write(Payload.PACKAGE.ordinal());
                        current--;
                        stats.recordConsumed(consumerIndex);  
                        if (!producerQueue.isEmpty()) {
                            int queuedProducerIndex = producerQueue.removeFirst();
                            toProducerChannels[queuedProducerIndex].out().write(Payload.HERE.ordinal());
                            if (fromProducerChannels[queuedProducerIndex].in().read() == Payload.PACKAGE.ordinal()) {
                                current++;
                                stats.recordProduced(queuedProducerIndex);
                            }
                        }          
                    } else {
                        passConsumerChannel.out().write(new PassPayload(Id, consumerIndex));
                        stats.recordConsumerPass(consumerIndex); 
                    }
                }

            } else if (index == guards.length - 2) {
                PassPayload passPayload = receivePassedProducerChannel.in().read();
                int producerIndex = passPayload.pcIndex();
                int ogBufferIndex = passPayload.ogBufferIndex();
                if (current < bufferSize) {
                    toProducerChannels[producerIndex].out().write(Payload.HERE.ordinal());
                    if (fromProducerChannels[producerIndex].in().read() == Payload.PACKAGE.ordinal()) {
                        current++;
                        stats.recordProduced(producerIndex);
                        if (!consumerQueue.isEmpty()) {
                            int queuedConsumerIndex = consumerQueue.removeFirst();
                            toConsumerChannels[queuedConsumerIndex].out().write(Payload.HERE.ordinal());
                            toConsumerChannels[queuedConsumerIndex].out().write(Payload.PACKAGE.ordinal());
                            current--;
                            stats.recordConsumed(queuedConsumerIndex);
                        }
                    }
                } else if (ogBufferIndex != Id) {
                    passProducerChannel.out().write(passPayload);
                    stats.recordProducerPass(producerIndex);
                } else {
                    producerQueue.addLast(producerIndex);
                }

            } else if (index == guards.length - 1) {
                PassPayload passPayload = receivePassedConsumerChannel.in().read();
                int consumerIndex = passPayload.pcIndex();
                int ogBufferIndex = passPayload.ogBufferIndex();
                if (current > 0) {
                    toConsumerChannels[consumerIndex].out().write(Payload.HERE.ordinal());
                    toConsumerChannels[consumerIndex].out().write(Payload.PACKAGE.ordinal());
                    current--;
                    stats.recordConsumed(consumerIndex);
                    if (!producerQueue.isEmpty()) {
                        int queuedProducerIndex = producerQueue.removeFirst();
                        toProducerChannels[queuedProducerIndex].out().write(Payload.HERE.ordinal());
                        if (fromProducerChannels[queuedProducerIndex].in().read() == Payload.PACKAGE.ordinal()) {
                            current++;
                            stats.recordProduced(queuedProducerIndex);
                        }
                    }
                } else  if (ogBufferIndex != Id) {
                    passConsumerChannel.out().write(passPayload);
                    stats.recordConsumerPass(consumerIndex);
                } else {
                    consumerQueue.addLast(consumerIndex);
                }
            }
        }
    }

}
